---
title: "2022-10-17 Alex MS4A qPCR"
format: 
   html:
     df-print: paged
---

```{r}
#| message: FALSE
library(tidyverse)
library(magrittr)
library(readxl)
library(janitor)
library(broom.mixed)
library(lmerTest)
library(DHARMa)
library(emmeans)
theme_set(theme_minimal())
```

```{r}
df = read_csv("iMGL_iso_samples_combined_qPCR_clean.csv", show_col_types = FALSE) %>% clean_names()

df
```

```{r}
df %<>%
  mutate(genotype = fct_relevel(genotype, "CC"),
         treatment = fct_relevel(treatment, "Basal"),
         experiment = factor(experiment),
         line = factor(line),
         cell_type = factor(cell_type),
         log2.gxp = max(avg_ct) - avg_ct) %>%
  rename(gene = target_name)
  
df
```

```{r}
df %>%
  ggplot(aes(x = gene, y = log2.gxp, color = gene, shape = genotype)) +
  geom_point(stat = "identity") +
  theme(axis.text.x = element_blank()) + # theme(axis.text.x = element_text(angle = 45, size = rel(0.5))) +
  facet_wrap(~ line + experiment + treatment)
```

```{r}
df.ms4a4a = df %>%
  filter(gene == "MS4A4A")

fit.ms4a4a = lmer(d_ct ~ 1 + genotype*treatment + (1 | line), data = df.ms4a4a)

summary(fit.ms4a4a)
```

```{r}
# |warning: FALSE
plot(simulateResiduals(fit.ms4a4a))
```

```{r}
(em.ms4a4a = emmeans(fit.ms4a4a, pairwise ~ genotype | treatment))
```

```{r}
# flip contrast and convert to fold change
confint.ms4a4a = as_tibble(confint(em.ms4a4a)$contrasts) %>%
      mutate(contrast = "TT - CC") %>%
      mutate(across(c(-contrast, - treatment), ~ 2^(.x)))

confint.ms4a4a
```

```{r}
confint.ms4a4a %<>%
  left_join(as_tibble(em.ms4a4a$contrasts) %>%
              select(treatment, p.value),
            by = "treatment")

confint.ms4a4a
```

```{r}
confint.ms4a4a %>%
  ggplot(aes(x = treatment, y = estimate)) +
  geom_point(stat="identity") +
  geom_errorbar(aes(ymin=lower.CL, ymax=upper.CL), width=.2) +
  geom_text(aes(y = upper.CL, label = ifelse(p.value < 0.001, "***", ifelse(p.value < 0.01, "**", ifelse(p.value < 0.05, "*", "")))), vjust = -0.5) +
  ylim(0, 8) +
  ylab("Fold change (TT - CC)") +
  ggtitle("MS4A4A")
```
